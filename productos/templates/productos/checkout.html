{% extends 'productos/base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
{% if carrito.carritoproducto_set.exists %}
<div class="checkout-card">
    <h1>Checkout</h1>
    <table class="carrito-tabla">
        <thead>
            <tr>
                <th>Imagen</th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            {% for item in carrito.carritoproducto_set.all %}
            <tr>
                <td>
                    {% if item.producto.imagen %}
                        <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="producto-img">
                    {% else %}
                        <img src="https://via.placeholder.com/40" alt="Sin imagen" class="producto-img">
                    {% endif %}
                </td>
                <td>{{ item.producto.nombre }}</td>
                <td>${{ item.producto.precio }}</td>
                <td>{{ item.cantidad }}</td>
                <td><strong>${{ item.subtotal }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="total-botones-container">
        <p>Total: ${{ total }}</p>
    </div>
</div>

<div class="checkout-form-container">
    <form id="checkout-form" method="post" action="{% url 'checkout' %}">
        {% csrf_token %}
        <input type="text" name="direccion" id="direccion" placeholder="Dirección" required>
        <div class="form-botones">
            <a href="{% url 'ver_carrito' %}" class="btn-volver">Volver al carrito</a>
            <button type="submit" class="btn-finalizar">Finalizar Compra</button>
        </div>
        <div id="checkout-mensaje" class="checkout-mensaje"></div>
    </form>
</div>

<script>
const form = document.getElementById('checkout-form');
const mensajeDiv = document.getElementById('checkout-mensaje');

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    mensajeDiv.textContent = "Procesando tu pedido...";
    mensajeDiv.style.color = "blue";

    const formData = new FormData(form);

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const url = await response.text();

        if (url.startsWith('http')) {
            mensajeDiv.textContent = "Redirigiendo al pago...";
            window.open(url, '_blank');
            window.location.href = "{% url 'pago_aprobado' %}";
        } else {
            mensajeDiv.textContent = "No se pudo generar la preferencia de pago. Intenta de nuevo.";
            mensajeDiv.style.color = "red";
        }

    } catch (err) {
        console.error("Error en fetch:", err);
        mensajeDiv.textContent = "Ocurrió un error inesperado al generar el link de pago.";
        mensajeDiv.style.color = "red";
    }
});
</script>

{% else %}
<p>No hay productos en el carrito.</p>
<a href="{% url 'lista_productos' %}" class="botones-carrito">Volver a la tienda</a>
{% endif %}
{% endblock %}
