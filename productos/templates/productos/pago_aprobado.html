{% extends 'productos/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/pago_aprobado.css' %}">

<!-- ================= CARD PRINCIPAL ================= -->
<div class="pago-card">
    <h1>Pago Aprobado</h1>

    <!-- Explicaci√≥n del proceso -->
    <p>Una vez que confirmes tu pago, se generar√° tu pedido, se descontar√° el stock y podr√°s descargar el PDF.</p>

    <!-- Bot√≥n para confirmar el pago y generar el pedido -->
    <button id="confirmar-pago-btn">Confirmar Pago y Generar Pedido</button>

    <!-- Mensajes din√°micos (√©xito, error, procesando) -->
    <p id="mensaje"></p>

    <!-- Link para descargar el PDF del pedido, oculto inicialmente -->
    <a id="link-pdf" href="#" target="_blank" style="display:none;">üìÑ Descargar PDF del pedido</a>
</div>

<!-- Link para volver a la tienda -->
<a class="volver-tienda" href="{% url 'lista_productos' %}">Volver a la tienda</a>

<script>
/* ================= FUNCIONES AUXILIARES ================= */
// Funci√≥n para obtener CSRF token desde la cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
const btn = document.getElementById('confirmar-pago-btn');
const mensaje = document.getElementById('mensaje');
const linkPDF = document.getElementById('link-pdf');

/* ================= EVENTO CLICK DEL BOT√ìN ================= */
btn.addEventListener('click', async function() {
    mensaje.textContent = "Procesando..."; // Mostrar mensaje mientras se procesa

    try {
        // Realizar petici√≥n POST para generar el pedido
        const response = await fetch("{% url 'pago_aprobado' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,          // Token CSRF para seguridad
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        // Mostrar mensajes seg√∫n el resultado
        if (data.status === 'ok') {
            mensaje.textContent = "‚úÖ Pedido generado correctamente. Gracias por tu compra.";
            if (data.pdf_url) {
                linkPDF.href = data.pdf_url;
                linkPDF.style.display = 'inline-block'; // Mostrar link al PDF
            }
        } else {
            mensaje.textContent = "‚ùå " + data.message; // Error enviado por el servidor
        }
    } catch (err) {
        console.error("Error en fetch:", err);
        mensaje.textContent = "‚ùå Ocurri√≥ un error inesperado. Intenta nuevamente.";
    }
});
</script>

{% endblock %}
